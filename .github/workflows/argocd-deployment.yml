name: ArgoCD Deployment

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - install
          - uninstall

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: ticket-booking-eks

jobs:
  argocd:
    name: ${{ github.event.inputs.action }} ArgoCD
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
          kubectl get nodes
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
      
      - name: Install ArgoCD
        if: github.event.inputs.action == 'install'
        run: |
          # Add ArgoCD Helm repo
          helm repo add argo https://argoproj.github.io/argo-helm
          helm repo update
          
          # Create namespace
          kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
          
          # Get values.yaml from argocd repo
          curl -sSL -o /tmp/values.yaml \
            https://raw.githubusercontent.com/test-booking-application/argocd/main/values.yaml
          
          # Install ArgoCD
          helm upgrade --install argocd argo/argo-cd \
            --namespace argocd \
            --version 5.51.6 \
            -f /tmp/values.yaml \
            --wait \
            --timeout 10m
          
          echo "‚úÖ ArgoCD installed successfully!"
          
          # Wait for service to be ready
          sleep 10
          
          # Get Admin Password
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo ""
          echo "üîê ArgoCD Admin Password: $PASSWORD"
          echo "   üëâ SAVE THIS PASSWORD!"
          
          # Deploy DuckDNS Updater for ArgoCD
          echo ""
          echo "ü¶Ü Deploying DuckDNS Updater for ArgoCD..."
          # Download updater manifest
          curl -sSL -o /tmp/duckdns-updater-argocd.yaml \
            https://raw.githubusercontent.com/test-booking-application/tools/main/dns/duckdns-updater-argocd.yaml
            
          kubectl apply -f /tmp/duckdns-updater-argocd.yaml
          
          # Trigger immediately
          kubectl create job --from=cronjob/duckdns-updater-argocd duckdns-argocd-init-trigger -n argocd || true
          echo "‚úÖ DuckDNS Updater deployed and triggered"
          
          echo ""
          echo "üìã ACCESS INSTRUCTIONS:"
          echo "============================================"
          echo "1Ô∏è‚É£  Wait 2-5 minutes for DNS propagation"
          echo "2Ô∏è‚É£  Access ArgoCD:"
          echo "   - URL: https://argocd007.duckdns.org"
          echo "   - Username: admin"
          echo "   - Password: (from above)"
      
      - name: Uninstall ArgoCD
        if: github.event.inputs.action == 'uninstall'
        run: |
          helm uninstall argocd -n argocd || true
          kubectl delete namespace argocd --ignore-not-found=true
          echo "‚úÖ ArgoCD uninstalled successfully!"
      
      - name: Verify ArgoCD Status
        if: github.event.inputs.action == 'install'
        run: |
          echo "üìä ArgoCD Deployment Status:"
          kubectl get pods -n argocd
          echo ""
          echo "üîó Services:"
          kubectl get svc -n argocd
