name: ArgoCD Deployment

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - install
          - uninstall

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: ticket-booking-eks

jobs:
  argocd:
    name: ${{ github.event.inputs.action }} ArgoCD
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
          kubectl get nodes
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
      
      - name: Install ArgoCD
        if: github.event.inputs.action == 'install'
        run: |
          cd tools/cicd/argocd
          
          # Add ArgoCD Helm repo
          helm repo add argo https://argoproj.github.io/argo-helm
          helm repo update
          
          # Create namespace
          kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
          
          # Install ArgoCD
          helm upgrade --install argocd argo/argo-cd \
            --namespace argocd \
            --version 5.51.6 \
            -f values.yaml \
            --wait \
            --timeout 10m
          
          echo "‚úÖ ArgoCD installed successfully!"
          
          # Wait for service to be ready
          sleep 10
          
          # Get Admin Password
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo ""
          echo "üîê ArgoCD Admin Password: $PASSWORD"
          echo "   üëâ SAVE THIS PASSWORD!"
          
          # Get LoadBalancer IP
          echo ""
          echo "‚è≥ Waiting for LoadBalancer IP (this takes 2-5 minutes)..."
          for i in {1..60}; do
            LB_IP=$(kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
            if [ -z "$LB_IP" ]; then
              echo "   Attempt $i/60..."
              sleep 5
            else
              echo ""
              echo "‚úÖ LoadBalancer IP assigned: $LB_IP"
              echo ""
              echo "üìã NEXT STEPS FOR YOUR LEARNING SETUP:"
              echo "============================================"
              echo "1Ô∏è‚É£  Point DuckDNS to LoadBalancer IP:"
              echo "   - Go to: https://www.duckdns.org"
              echo "   - Sign in with your account"
              echo "   - Find 'argocd007' domain"
              echo "   - Update IP to: $LB_IP"
              echo "   - Hit 'update'"
              echo ""
              echo "2Ô∏è‚É£  Wait 5-10 minutes for DNS propagation"
              echo ""
              echo "3Ô∏è‚É£  Access ArgoCD:"
              echo "   - URL: https://argocd007.duckdns.org"
              echo "   - Username: admin"
              echo "   - Password: (from above)"
              echo ""
              echo "4Ô∏è‚É£  When you destroy EKS (to learn/retry):"
              echo "   - Run this workflow with 'uninstall' action"
              echo "   - This removes ArgoCD completely"
              echo "   - Next time you create EKS, just re-run with 'install'"
              break
            fi
          done
      
      - name: Uninstall ArgoCD
        if: github.event.inputs.action == 'uninstall'
        run: |
          helm uninstall argocd -n argocd || true
          kubectl delete namespace argocd --ignore-not-found=true
          echo "‚úÖ ArgoCD uninstalled successfully!"
      
      - name: Verify ArgoCD Status
        if: github.event.inputs.action == 'install'
        run: |
          echo "üìä ArgoCD Deployment Status:"
          kubectl get pods -n argocd
          echo ""
          echo "üîó Services:"
          kubectl get svc -n argocd
