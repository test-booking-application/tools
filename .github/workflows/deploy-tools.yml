name: Deploy Tools to EKS

on:
  workflow_dispatch:
    inputs:
      # NEW: A "Select All" convenience checkbox
      select_all:
        description: 'Select All Tools'
        required: true
        type: boolean
        default: false

      # NEW: Individual boolean inputs for each tool. These appear as checkboxes.
      install_prometheus:
        description: 'Install Prometheus'
        required: true
        type: boolean
        default: false
      install_grafana:
        description: 'Install Grafana'
        required: true
        type: boolean
        default: false
      install_alertmanager:
        description: 'Install Alertmanager'
        required: true
        type: boolean
        default: false
      install_cloudwatch:
        description: 'Install CloudWatch Monitoring'
        required: true
        type: boolean
        default: false
      install_elasticsearch:
        description: 'Install Elasticsearch'
        required: true
        type: boolean
        default: false
      install_kibana:
        description: 'Install Kibana'
        required: true
        type: boolean
        default: false
      install_filebeat:
        description: 'Install Filebeat'
        required: true
        type: boolean
        default: false
      install_nginx_ingress:
        description: 'Install Nginx Ingress'
        required: true
        type: boolean
        default: false
      install_jenkins:
        description: 'Install Jenkins'
        required: true
        type: boolean
        default: false

      action:
        description: 'Action'
        required: true
        type: choice
        options:
          - install
          - uninstall

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: ticket-booking-eks

# NEW: This job's purpose is to parse the checkbox inputs and create a list of tools to deploy.
jobs:
  determine-tools:
    name: Determine Tools to Deploy
    runs-on: ubuntu-latest
    outputs:
      # This output will be a JSON array of tools, e.g., ["prometheus", "grafana"]
      selected-tools: ${{ steps.set-matrix.outputs.tools }}
    steps:
      - name: Build tool list from inputs
        id: set-matrix
        run: |
          tools=()
          # If "Select All" is checked, add all tools to the list
          if [ "${{ github.event.inputs.select_all }}" == "true" ]; then
            tools+=("prometheus")
            tools+=("grafana")
            tools+=("alertmanager")
            tools+=("cloudwatch-monitoring")
            tools+=("elasticsearch")
            tools+=("kibana")
            tools+=("filebeat")
            tools+=("nginx-ingress")
            tools+=("jenkins")
          else
            # Otherwise, check each individual checkbox
            if [ "${{ github.event.inputs.install_prometheus }}" == "true" ]; then
              tools+=("prometheus")
            fi
            if [ "${{ github.event.inputs.install_grafana }}" == "true" ]; then
              tools+=("grafana")
            fi
            if [ "${{ github.event.inputs.install_alertmanager }}" == "true" ]; then
              tools+=("alertmanager")
            fi
            if [ "${{ github.event.inputs.install_cloudwatch }}" == "true" ]; then
              tools+=("cloudwatch-monitoring")
            fi
            if [ "${{ github.event.inputs.install_elasticsearch }}" == "true" ]; then
              tools+=("elasticsearch")
            fi
            if [ "${{ github.event.inputs.install_kibana }}" == "true" ]; then
              tools+=("kibana")
            fi
            if [ "${{ github.event.inputs.install_filebeat }}" == "true" ]; then
              tools+=("filebeat")
            fi
            if [ "${{ github.event.inputs.install_nginx_ingress }}" == "true" ]; then
              tools+=("nginx-ingress")
            fi
            if [ "${{ github.event.inputs.install_jenkins }}" == "true" ]; then
              tools+=("jenkins")
            fi
          fi

          # Convert the bash array into a JSON array string for the matrix
          # The 'jq' command is a reliable way to do this.
          json_array=$(printf '%s\n' "${tools[@]}" | jq -R . | jq -s .)
          echo "tools=${json_array}" >> $GITHUB_OUTPUT
          echo "Selected tools: ${json_array}"

# This is the main deployment job. It now depends on the job above.
  deploy:
    name: Deploy ${{ matrix.tool }}
    # ADDED: This job needs the output from the 'determine-tools' job
    needs: determine-tools
    runs-on: ubuntu-latest
    
    # ADDED: Strategy matrix to loop through the tools selected by the user
    strategy:
      fail-fast: false
      matrix:
        # The matrix is populated from the output of the previous job
        tool: ${{ fromJson(needs.determine-tools.outputs.selected-tools) }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
          kubectl get nodes
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Install eksctl
        run: |
          ARCH=amd64
          PLATFORM=$(uname -s)_$ARCH
          curl -sLO "https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_$PLATFORM.tar.gz"
          tar -xzf eksctl_$PLATFORM.tar.gz -C /tmp && rm eksctl_$PLATFORM.tar.gz
          sudo mv /tmp/eksctl /usr/local/bin
          eksctl version
      
      # UPDATED: All if conditions now check against the matrix.tool variable
      - name: Deploy Prometheus
        if: matrix.tool == 'prometheus'
        continue-on-error: true
        run: |
          cd monitoring/prometheus
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            helm upgrade --install prometheus . -n monitoring --create-namespace -f values.yaml --wait
            echo "âœ… Prometheus deployed"
          else
            helm uninstall prometheus -n monitoring || true
            echo "ðŸ—‘ï¸ Prometheus removed"
          fi
      
      - name: Deploy Grafana
        if: matrix.tool == 'grafana'
        continue-on-error: true
        run: |
          cd monitoring/grafana
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            helm upgrade --install grafana . -n monitoring --create-namespace -f values.yaml --wait
            echo "âœ… Grafana deployed"
            kubectl get svc -n monitoring grafana
          else
            helm uninstall grafana -n monitoring || true
            echo "ðŸ—‘ï¸ Grafana removed"
          fi
      
      - name: Deploy Alertmanager
        if: matrix.tool == 'alertmanager'
        continue-on-error: true
        run: |
          cd monitoring/alertmanager
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            helm upgrade --install alertmanager . -n monitoring --create-namespace -f values.yaml --wait
            echo "âœ… Alertmanager deployed"
          else
            helm uninstall alertmanager -n monitoring || true
            echo "ðŸ—‘ï¸ Alertmanager removed"
          fi
      - name: Deploy CloudWatch Monitoring
        if: matrix.tool == 'cloudwatch-monitoring'
        continue-on-error: true
        run: |
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            echo "ðŸš€ Installing CloudWatch Container Insights..."
            cd monitoring/cloudwatch
            chmod +x install-addon.sh
            ./install-addon.sh
            echo "âœ… CloudWatch Monitoring deployed"
          else
            echo "ðŸ—‘ï¸ Removing CloudWatch Monitoring..."
            aws eks delete-addon --cluster-name ${{ env.EKS_CLUSTER_NAME }} --addon-name amazon-cloudwatch-observability --region ${{ env.AWS_REGION }} || true
            kubectl delete namespace amazon-cloudwatch || true
            echo "âœ… CloudWatch Monitoring removed"
          fi
      
      - name: Deploy Elasticsearch
        if: matrix.tool == 'elasticsearch'
        continue-on-error: true
        run: |
          cd logging/elasticsearch
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            helm upgrade --install elasticsearch . -n logging --create-namespace -f values.yaml --wait
            echo "âœ… Elasticsearch deployed"
          else
            helm uninstall elasticsearch -n logging || true
            echo "ðŸ—‘ï¸ Elasticsearch removed"
          fi
      
      - name: Deploy Kibana
        if: matrix.tool == 'kibana'
        continue-on-error: true
        run: |
          cd logging/kibana
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            echo "â³ Waiting 60s for Elasticsearch to initialize..."
            sleep 60
            helm upgrade --install kibana . -n logging --create-namespace -f values.yaml --wait --timeout 5m
            echo "âœ… Kibana deployed"
            kubectl get svc -n logging kibana
          else
            helm uninstall kibana -n logging || true
            echo "ðŸ—‘ï¸ Kibana removed"
          fi
      
      - name: Deploy Filebeat
        if: matrix.tool == 'filebeat'
        continue-on-error: true
        run: |
          cd logging/filebeat
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            helm upgrade --install filebeat . -n logging --create-namespace -f values.yaml --wait
            echo "âœ… Filebeat deployed"
          else
            helm uninstall filebeat -n logging || true
            echo "ðŸ—‘ï¸ Filebeat removed"
          fi
      
      - name: Deploy Nginx Ingress
        if: matrix.tool == 'nginx-ingress'
        continue-on-error: true
        run: |
          cd ingress/nginx-ingress
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            helm upgrade --install nginx-ingress . -n ingress-nginx --create-namespace -f values.yaml --wait
            echo "âœ… Nginx Ingress deployed"
            kubectl get svc -n ingress-nginx
          else
            helm uninstall nginx-ingress -n ingress-nginx || true
            echo "ðŸ—‘ï¸ Nginx Ingress removed"
          fi
      
      - name: Deploy Jenkins
        if: matrix.tool == 'jenkins'
        run: |
          cd cicd/jenkins
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            helm upgrade --install jenkins . -n jenkins --create-namespace -f values.yaml --wait --timeout 10m
            kubectl apply -f jenkins-rbac.yaml
            echo "âœ… Jenkins deployed with RBAC permissions"
            kubectl get svc -n jenkins jenkins
          else
            helm uninstall jenkins -n jenkins || true
            kubectl delete -f jenkins-rbac.yaml || true
            echo "ðŸ—‘ï¸ Jenkins removed"
          fi
      
      - name: Display Access Information
        if: github.event.inputs.action == 'install'
        run: |
          echo "========================================="
          echo "Tool Deployment Complete for ${{ matrix.tool }}!"
          echo "========================================="
          echo ""
          echo "ðŸ“Š Access Grafana:"
          kubectl get svc -n monitoring grafana 2>/dev/null || echo "Not deployed in this run"
          echo "   Username: admin"
          echo "   Password: admin"
          echo ""
          echo "ðŸ“Š Access CloudWatch:"
          echo "   Dashboard: https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#container-insights:infrastructure"
          echo ""
          echo "ðŸ“Š Access Kibana:"
          kubectl get svc -n logging kibana 2>/dev/null || echo "Not deployed in this run"
          echo ""
          echo "ðŸŒ Ingress LoadBalancer:"
          kubectl get svc -n ingress-nginx 2>/dev/null || echo "Not deployed in this run"
          echo ""
          echo "ðŸš€ Access Jenkins:"
          kubectl get svc -n jenkins jenkins 2>/dev/null || echo "Not deployed in this run"
          echo "   Username: admin"
          echo "   Password: admin"
          echo ""
          echo "ðŸ’¡ Tip: Use port-forward for consistent localhost access:"
          echo "   kubectl port-forward svc/grafana 3000:80 -n monitoring"
          echo "   kubectl port-forward svc/jenkins 8080:8080 -n jenkins"
