name: Deploy Tools to EKS

on:
  workflow_dispatch:
    inputs:
      tool:
        description: 'Tool to deploy'
        required: true
        type: choice
        options:
          - all
          - prometheus
          - grafana
          - alertmanager
          - elasticsearch
          - kibana
          - filebeat
          - nginx-ingress
          - cloudwatch-monitoring
          - external-dns
          - jenkins
      action:
        description: 'Action'
        required: true
        type: choice
        options:
          - install
          - uninstall

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: ticket-booking-eks

jobs:
  # Common setup (always runs first)
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
          kubectl get nodes
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
          token: ${{ secrets.GITHUB_TOKEN }}  # â† FIX: Adds missing GITHUB_TOKEN to suppress warning
      
      - name: Install eksctl
        run: |
          ARCH=amd64
          PLATFORM=$(uname -s)_$ARCH
          curl -sLO "https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_$PLATFORM.tar.gz"
          tar -xzf eksctl_$PLATFORM.tar.gz -C /tmp && rm eksctl_$PLATFORM.tar.gz
          sudo mv /tmp/eksctl /usr/local/bin
          eksctl version

  # Deploy non-Jenkins tools (runs if tool matches, including 'all')
  deploy-non-jenkins:
    name: Deploy Non-Jenkins Tools
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ github.event.inputs.tool != 'jenkins' || github.event.inputs.tool == 'all' }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
          kubectl get nodes
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
          token: ${{ secrets.GITHUB_TOKEN }}  # â† FIX: Same here for consistency
      
      - name: Install eksctl
        run: |
          ARCH=amd64
          PLATFORM=$(uname -s)_$ARCH
          curl -sLO "https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_$PLATFORM.tar.gz"
          tar -xzf eksctl_$PLATFORM.tar.gz -C /tmp && rm eksctl_$PLATFORM.tar.gz
          sudo mv /tmp/eksctl /usr/local/bin
          eksctl version
      
      # Prometheus
      - name: Deploy Prometheus
        if: contains(fromJson('["prometheus", "all"]'), github.event.inputs.tool)
        continue-on-error: true
        run: |
          cd monitoring/prometheus
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            helm upgrade --install prometheus . -n monitoring --create-namespace -f values.yaml --wait
            echo "âœ… Prometheus deployed"
          else
            helm uninstall prometheus -n monitoring || true
            echo "ðŸ—‘ï¸ Prometheus removed"
          fi
      
      # Grafana
      - name: Deploy Grafana
        if: contains(fromJson('["grafana", "all"]'), github.event.inputs.tool)
        continue-on-error: true
        run: |
          cd monitoring/grafana
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            helm upgrade --install grafana . -n monitoring --create-namespace -f values.yaml --wait
            echo "âœ… Grafana deployed"
            kubectl get svc -n monitoring grafana
          else
            helm uninstall grafana -n monitoring || true
            echo "ðŸ—‘ï¸ Grafana removed"
          fi
      
      # Alertmanager
      - name: Deploy Alertmanager
        if: contains(fromJson('["alertmanager", "all"]'), github.event.inputs.tool)
        continue-on-error: true
        run: |
          cd monitoring/alertmanager
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            helm upgrade --install alertmanager . -n monitoring --create-namespace -f values.yaml --wait
            echo "âœ… Alertmanager deployed"
          else
            helm uninstall alertmanager -n monitoring || true
            echo "ðŸ—‘ï¸ Alertmanager removed"
          fi
      
      # CloudWatch
      - name: Deploy CloudWatch Monitoring
        if: contains(fromJson('["cloudwatch-monitoring", "all"]'), github.event.inputs.tool)
        continue-on-error: true
        run: |
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            echo "ðŸš€ Installing CloudWatch Container Insights..."
            cd monitoring/cloudwatch
            chmod +x install-addon.sh
            ./install-addon.sh
            echo "âœ… CloudWatch Monitoring deployed"
          else
            echo "ðŸ—‘ï¸ Removing CloudWatch Monitoring..."
            aws eks delete-addon --cluster-name ${{ env.EKS_CLUSTER_NAME }} --addon-name amazon-cloudwatch-observability --region ${{ env.AWS_REGION }} || true
            kubectl delete namespace amazon-cloudwatch || true
            echo "âœ… CloudWatch Monitoring removed"
          fi
      
      # Elasticsearch
      - name: Deploy Elasticsearch
        if: contains(fromJson('["elasticsearch", "all"]'), github.event.inputs.tool)
        continue-on-error: true
        run: |
          cd logging/elasticsearch
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            helm upgrade --install elasticsearch . -n logging --create-namespace -f values.yaml --wait
            echo "âœ… Elasticsearch deployed"
          else
            helm uninstall elasticsearch -n logging || true
            echo "ðŸ—‘ï¸ Elasticsearch removed"
          fi
      
      # Kibana
      - name: Deploy Kibana
        if: contains(fromJson('["kibana", "all"]'), github.event.inputs.tool)
        continue-on-error: true
        run: |
          cd logging/kibana
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            echo "â³ Waiting 60s for Elasticsearch to initialize..."
            sleep 60
            helm upgrade --install kibana . -n logging --create-namespace -f values.yaml --wait --timeout 5m
            echo "âœ… Kibana deployed"
            kubectl get svc -n logging kibana
          else
            helm uninstall kibana -n logging || true
            echo "ðŸ—‘ï¸ Kibana removed"
          fi
      
      # Filebeat
      - name: Deploy Filebeat
        if: contains(fromJson('["filebeat", "all"]'), github.event.inputs.tool)
        continue-on-error: true
        run: |
          cd logging/filebeat
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            helm upgrade --install filebeat . -n logging --create-namespace -f values.yaml --wait
            echo "âœ… Filebeat deployed"
          else
            helm uninstall filebeat -n logging || true
            echo "ðŸ—‘ï¸ Filebeat removed"
          fi
      
      # Nginx Ingress
      - name: Deploy Nginx Ingress
        if: contains(fromJson('["nginx-ingress", "all"]'), github.event.inputs.tool)
        continue-on-error: true
        run: |
          cd ingress/nginx-ingress
          helm dependency update
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            helm upgrade --install nginx-ingress . -n ingress-nginx --create-namespace -f values.yaml --wait
            echo "âœ… Nginx Ingress deployed"
            kubectl get svc -n ingress-nginx
          else
            helm uninstall nginx-ingress -n ingress-nginx || true
            echo "ðŸ—‘ï¸ Nginx Ingress removed"
          fi
      
      # ExternalDNS
      - name: Deploy ExternalDNS
        if: contains(fromJson('["external-dns", "all"]'), github.event.inputs.tool)
        continue-on-error: true
        run: |
          if [ "${{ github.event.inputs.action }}" == "install" ]; then
            echo "ðŸš€ Installing ExternalDNS..."
            helm repo add external-dns https://kubernetes-sigs.github.io/external-dns/
            helm repo update
            cd dns/external-dns
            helm upgrade --install external-dns external-dns/external-dns \
              -n external-dns \
              --create-namespace \
              -f values.yaml \
              --wait --timeout 5m
            echo "âœ… ExternalDNS deployed"
            kubectl get pods -n external-dns
          else
            helm uninstall external-dns -n external-dns || true
            echo "ðŸ—‘ï¸ ExternalDNS removed"
          fi

  # Jenkins Install with Approval (only for install action)
  deploy-jenkins-install:
    name: "Deploy Jenkins â†’ Requires Approval"
    runs-on: ubuntu-latest
    environment: 
      name: jenkins-deploy-confirm
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    needs: [setup, deploy-non-jenkins]
    if: |
      (github.event.inputs.tool == 'jenkins' || github.event.inputs.tool == 'all') &&
      github.event.inputs.action == 'install'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
          kubectl get nodes
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
          token: ${{ secrets.GITHUB_TOKEN }}  # â† FIX: Suppress warning
      
      - name: Install eksctl
        run: |
          ARCH=amd64
          PLATFORM=$(uname -s)_$ARCH
          curl -sLO "https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_$PLATFORM.tar.gz"
          tar -xzf eksctl_$PLATFORM.tar.gz -C /tmp && rm eksctl_$PLATFORM.tar.gz
          sudo mv /tmp/eksctl /usr/local/bin
          eksctl version
      
      - name: Deploy Jenkins (Post-Approval)
        run: |
          echo "âœ… Manual approval confirmed â€” deploying Jenkins"
          echo "Reminder: Ensure you've run the credentials script: tools/cicd/jenkins/credentials.sh"
          cd cicd/jenkins
          helm dependency update
          helm upgrade --install jenkins . -n jenkins --create-namespace -f values.yaml --wait --timeout 10m
          kubectl apply -f jenkins-rbac.yaml || true
          echo "âœ… Jenkins deployed with RBAC permissions"
          kubectl get svc -n jenkins jenkins

  # Jenkins Uninstall (no approval, separate job)
  uninstall-jenkins:
    name: Uninstall Jenkins
    runs-on: ubuntu-latest
    needs: [setup, deploy-non-jenkins]
    if: |
      (github.event.inputs.tool == 'jenkins' || github.event.inputs.tool == 'all') &&
      github.event.inputs.action == 'uninstall'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
          kubectl get nodes
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
          token: ${{ secrets.GITHUB_TOKEN }}  # â† FIX: Suppress warning
      
      - name: Uninstall Jenkins
        run: |
          echo "ðŸ—‘ï¸ Uninstalling Jenkins (no approval required)"
          cd cicd/jenkins
          helm uninstall jenkins -n jenkins || true
          kubectl delete -f jenkins-rbac.yaml || true
          echo "ðŸ—‘ï¸ Jenkins removed"

  # Summary (only for install, with setup for kubectl)
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-non-jenkins, deploy-jenkins-install, uninstall-jenkins]
    if: github.event.inputs.action == 'install'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
          kubectl get nodes
      
      - name: Display Access Information
        run: |
          echo "========================================="
          echo "Tool Deployment Complete!"
          echo "========================================="
          echo ""
          echo "ðŸ“Š Access Grafana:"
          kubectl get svc -n monitoring grafana 2>/dev/null || echo "Grafana not deployed or no service found"
          echo " Username: admin"
          echo " Password: admin"
          echo ""
          echo "ðŸ“Š Access CloudWatch:"
          echo " Dashboard: https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#container-insights:infrastructure"
          echo ""
          echo "ðŸ“Š Access Kibana:"
          kubectl get svc -n logging kibana 2>/dev/null || echo "Kibana not deployed or no service found"
          echo ""
          echo "ðŸŒ Ingress LoadBalancer:"
          kubectl get svc -n ingress-nginx 2>/dev/null || echo "Nginx Ingress not deployed"
          echo ""
          echo "ðŸš€ Access Jenkins:"
          kubectl get svc -n jenkins jenkins 2>/dev/null || echo "Jenkins not deployed or no service found"
          echo " Username: admin"
          echo " Password: From credentials script (or default admin if not set)"
          echo ""
          echo "ðŸ’¡ Tip: Use port-forward for consistent localhost access:"
          echo " kubectl port-forward svc/grafana 3000:80 -n monitoring"
          echo " kubectl port-forward svc/kibana 5601:5601 -n logging"
          echo " kubectl port-forward svc/jenkins 8080:8080 -n jenkins"
