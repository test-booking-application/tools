name: Deploy Tools to EKS

on:
  workflow_dispatch:
    inputs:
      tool:
        description: 'Tool to deploy'
        required: true
        type: choice
        options:
          - all
          - prometheus
          - grafana
          - alertmanager
          - elasticsearch
          - kibana
          - filebeat
          - nginx-ingress
          - cloudwatch-monitoring
          - external-dns
          - jenkins
      action:
        description: 'Action'
        required: true
        type: choice
        options:
          - install
          - uninstall

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: ticket-booking-eks

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
      - uses: azure/setup-helm@v3
        with:
          version: latest
          token: ${{ secrets.GITHUB_TOKEN }}

  deploy-non-jenkins:
    name: Deploy Non-Jenkins Tools
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
      - uses: azure/setup-helm@v3
        with:
          version: latest
          token: ${{ secrets.GITHUB_TOKEN }}

      # ← All your existing tool steps (Prometheus, Grafana, etc.) go here unchanged →
      # (I kept them short for clarity — just paste your original steps)

  # THIS IS THE ONLY JOB THAT HAS THE APPROVAL BUTTON
  deploy-jenkins:
    name: "Deploy Jenkins → Click Approve to Continue"
    needs: [setup, deploy-non-jenkins]
    runs-on: ubuntu-latest
    environment: jenkins-deploy-confirm   # ← This triggers the button
    if: >-
      (github.event.inputs.tool == 'jenkins' || github.event.inputs.tool == 'all') &&
      github.event.inputs.action == 'install'

    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
      - uses: azure/setup-helm@v3
        with:
          version: latest
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Deploy Jenkins (after you click Approve)"
        run: |
          echo "APPROVAL RECEIVED — Deploying Jenkins now!"
          echo "Reminder: You confirmed the credentials script was run"
          cd cicd/jenkins
          helm dependency update
          helm upgrade --install jenkins . -n jenkins --create-namespace -f values.yaml --wait --timeout 15m
          kubectl apply -f jenkins-rbac.yaml || true
          echo "Jenkins deployed!"
          kubectl get svc -n jenkins jenkins

  uninstall-jenkins:
    name: Uninstall Jenkins (no approval)
    needs: [setup, deploy-non-jenkins]
    runs-on: ubuntu-latest
    if: >-
      (github.event.inputs.tool == 'jenkins' || github.event.inputs.tool == 'all') &&
      github.event.inputs.action == 'uninstall'
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
      - run: |
          helm uninstall jenkins -n jenkins || true
          kubectl delete -f cicd/jenkins/jenkins-rbac.yaml || true
          echo "Jenkins removed"

  summary:
    name: Summary
    needs: setup
    if: github.event.inputs.action == 'install'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
      - run: |
          echo "Deployment Summary"
          kubectl get svc -A | grep -E "(grafana|kibana|jenkins|ingress)"
