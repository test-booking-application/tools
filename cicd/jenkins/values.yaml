jenkins:
  controller:
    image:
      repository: "jenkins/jenkins"
      tag: "2.479.2-lts"
    admin:
      password: "admin"
    
    servicePort: 8080
    serviceType: LoadBalancer
    
    # Inject secrets as environment variables for JCasC
    containerEnv:
      - name: SONAR_TOKEN
        valueFrom:
          secretKeyRef:
            name: jenkins-credentials
            key: sonar-token
      - name: ECR_PASSWORD
        valueFrom:
          secretKeyRef:
            name: jenkins-credentials
            key: ecr-password
      - name: GITHUB_TOKEN
        valueFrom:
          secretKeyRef:
            name: jenkins-credentials
            key: github-token
    
    installPlugins:
      # Core Jackson library - must be first to avoid conflicts
      - jackson2-api:2.17.0-389.va_5c7e45cd806
      
      # Core Jenkins plugins
      - kubernetes
      - workflow-aggregator
      - git
      - configuration-as-code
      
      # Organization folder and branch discovery plugins (updated to meet dependencies)
      - cloudbees-folder:6.980.v5a_cc0cb_25881
      - branch-api:2.1206.vd9f35001c95c
      - scm-api:703.v72ff4b_259600
      - workflow-multibranch:795.ve0cb_1f45ca_9a_
      - workflow-scm-step:427.v4ca_6512e7df1
      
      # GitHub integration plugins
      - github:1.39.0
      - github-api:1.318-461.v7a_c09c9fa_d63
      - github-branch-source:1785.v99802b_69816c
      
      # Pipeline and Docker plugins
      - docker-workflow
      - pipeline-stage-view
      - credentials-binding
      
      # AWS plugins
      - aws-credentials
      - amazon-ecr
      
      # Job DSL plugin
      - job-dsl
    
    resources:
      requests:
        cpu: "1000m"
        memory: "1.5Gi"
      limits:
        cpu: "2000m"
        memory: "3Gi"
    
    # Give Jenkins more time to start up (critical for t3.medium)
    startupProbe:
      failureThreshold: 30
      periodSeconds: 10
      timeoutSeconds: 5
    
    persistence:
      enabled: true
      size: 8Gi
    
    JCasC:
      defaultConfig: true
      configScripts:
        welcome-message: |
          jenkins:
            systemMessage: "Jenkins for Ticket Booking Microservices CI/CD"
        
        cloud-config: |
          jenkins:
            clouds:
              - kubernetes:
                  name: "kubernetes"
                  serverUrl: "https://kubernetes.default"
                  namespace: "jenkins"
                  jenkinsUrl: "http://jenkins.jenkins.svc.cluster.local:8080"
                  jenkinsTunnel: "jenkins-agent:50000"
                  templates:
                    - name: "default"
                      label: "jenkins-agent"
                      nodeUsageMode: NORMAL
                      containers:
                        - name: "jnlp"
                          image: "jenkins/inbound-agent:latest"
                          workingDir: "/home/jenkins/agent"
                          resourceRequestCpu: "200m"
                          resourceRequestMemory: "256Mi"
                          resourceLimitCpu: "500m"
                          resourceLimitMemory: "512Mi"
        
        credentials-config: |
          credentials:
            system:
              domainCredentials:
                - credentials:
                    - string:
                        id: "sonar-token"
                        scope: GLOBAL
                        description: "SonarCloud Token"
                        secret: "${SONAR_TOKEN}"
                    - usernamePassword:
                        id: "aws-ecr-creds"
                        scope: GLOBAL
                        description: "AWS ECR Credentials"
                        username: "AWS"
                        password: "${ECR_PASSWORD}"
                    - usernamePassword:
                        id: "github-token"
                        scope: GLOBAL
                        description: "GitHub Personal Access Token"
                        username: "${GITHUB_TOKEN}"
                        password: ""
        
        jobs-config: |
          jobs:
            - script: >
                organizationFolder('booking-app-org-scan') {
                  description('Auto-discover all microservices in test-booking-application organization')
                  displayName('Ticket Booking App (New)')
                  organizations {
                    github {
                      apiUri('https://api.github.com')
                      repoOwner('test-booking-application')
                      credentialsId('github-token')
                      traits {
                        gitHubBranchDiscovery {
                          strategyId(1)
                        }
                        gitHubPullRequestDiscovery {
                          strategyId(1)
                        }
                      }
                    }
                  }
                  orphanedItemStrategy {
                    discardOldItems {
                      numToKeep(10)
                    }
                  }
                  triggers {
                    periodicFolderTrigger {
                      interval('1m')
                    }
                  }
                }
            
            - script: >
                folder('cd-pipelines') {
                  displayName('CD Pipelines')
                  description('Continuous Deployment pipelines for microservices')
                }
            
            - script: >
                pipelineJob('cd-pipelines/ticket-service-cd') {
                  displayName('ticket-service CD')
                  definition {
                    cpsScm {
                      scm {
                        git {
                          remote {
                            url('https://github.com/test-booking-application/ticket-service.git')
                            credentials('github-token')
                          }
                          branch('*/main')
                        }
                      }
                      scriptPath('Jenkinsfile.cd')
                      lightweight(true)
                    }
                  }
                }
            
            - script: >
                pipelineJob('cd-pipelines/user-service-cd') {
                  displayName('user-service CD')
                  definition {
                    cpsScm {
                      scm {
                        git {
                          remote {
                            url('https://github.com/test-booking-application/user-service.git')
                            credentials('github-token')
                          }
                          branch('*/main')
                        }
                      }
                      scriptPath('Jenkinsfile.cd')
                      lightweight(true)
                    }
                  }
                }
            
            - script: >
                pipelineJob('cd-pipelines/booking-service-cd') {
                  displayName('booking-service CD')
                  definition {
                    cpsScm {
                      scm {
                        git {
                          remote {
                            url('https://github.com/test-booking-application/booking-service.git')
                            credentials('github-token')
                          }
                          branch('*/main')
                        }
                      }
                      scriptPath('Jenkinsfile.cd')
                      lightweight(true)
                    }
                  }
                }
            
            - script: >
                pipelineJob('cd-pipelines/api-gateway-cd') {
                  displayName('api-gateway CD')
                  definition {
                    cpsScm {
                      scm {
                        git {
                          remote {
                            url('https://github.com/test-booking-application/api-gateway.git')
                            credentials('github-token')
                          }
                          branch('*/main')
                        }
                      }
                      scriptPath('Jenkinsfile.cd')
                      lightweight(true)
                    }
                  }
                }
            
            - script: >
                pipelineJob('cd-pipelines/frontend-cd') {
                  displayName('frontend CD')
                  definition {
                    cpsScm {
                      scm {
                        git {
                          remote {
                            url('https://github.com/test-booking-application/frontend.git')
                            credentials('github-token')
                          }
                          branch('*/main')
                        }
                      }
                      scriptPath('Jenkinsfile.cd')
                      lightweight(true)
                    }
                  }
                }
  
  agent:
    enabled: true
    resources:
      requests:
        cpu: "200m"
        memory: "256Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"
